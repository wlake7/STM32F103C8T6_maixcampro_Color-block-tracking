# 激光追踪系统 v2.1 发布说明

**发布日期**: 2025-07-07  
**版本**: v2.1  
**Git标签**: v2.1  
**提交哈希**: 9cb3460

## 🎯 版本概述

v2.1版本主要专注于硬件功能验证和通信稳定性优化，添加了完整的舵机测试功能，并重构了MaixCam通信模块以解决串口连接问题。

## 🚀 新功能

### 1. STM32舵机测试功能
- **循环测试模式**: 两个舵机按8个预设位置循环运动
- **实时控制**: 按键启动/停止测试，支持随时中断
- **状态指示**: OLED显示测试进度，LED闪烁指示状态
- **安全设计**: 测试停止时舵机自动回到中心位置

#### 测试位置序列
1. 水平左，垂直中 (200, 500)
2. 水平右，垂直中 (800, 500)
3. 水平中，垂直上 (500, 200)
4. 水平中，垂直下 (500, 800)
5. 左上角 (200, 200)
6. 右上角 (800, 200)
7. 右下角 (800, 800)
8. 左下角 (200, 800)

### 2. MaixCam通信模块重构
- **CommProtocol支持**: 优先使用MaixPy内置的`comm.CommProtocol`类
- **自动回退机制**: CommProtocol失败时自动回退到UART方式
- **智能串口检测**: 自动检测可用串口设备并更新配置
- **增强错误处理**: 多层次错误处理和状态管理

### 3. 诊断和修复工具集
- **快速修复脚本**: `fix_communication.py` 一键解决通信问题
- **UART诊断工具**: `test_uart.py` 全面检测串口状态
- **通信测试工具**: `test_communication_v2.py` 验证新通信模块
- **故障排除文档**: 详细的问题诊断和解决方案

## 🔧 改进和修复

### STM32端改进
- **修复switch语句bug**: 将`switch (SYSTEM_STATE_TRACKING)`改为`switch (g_system_state)`
- **增强按键处理**: 添加按键2触发舵机测试功能
- **完善状态管理**: 改进系统状态切换逻辑

### MaixCam端改进
- **通信稳定性**: 解决"串口未连接，无法发送数据"问题
- **兼容性增强**: 支持多种通信方式和自动适配
- **配置自动更新**: 检测到可用串口时自动更新配置文件

## 📁 新增文件

### STM32相关
- `stm32/SERVO_TEST_GUIDE.md` - 舵机测试功能使用指南
- `stm32/test_servo_function.c` - 舵机测试功能验证文件

### MaixCam相关
- `maixcam/communication_simple.py` - 简化版通信模块
- `maixcam/fix_communication.py` - 通信问题快速修复脚本
- `maixcam/test_communication_v2.py` - 改进后的通信测试工具
- `maixcam/test_uart.py` - UART设备诊断工具
- `maixcam/fix_uart.py` - UART问题修复工具
- `maixcam/quick_fix.py` - 快速UART修复脚本
- `maixcam/UART_TROUBLESHOOTING.md` - UART故障排除指南
- `maixcam/comm_protocol_yolov5.py` - CommProtocol参考实现

## 🎮 使用方法

### 舵机测试功能
1. 编译并烧录STM32程序
2. 按键1切换到MANUAL模式
3. 按键2启动舵机测试
4. 观察舵机循环运动
5. 再次按键2停止测试

### 通信问题修复
```bash
# 方法1: 快速修复
cd maixcam
python fix_communication.py

# 方法2: 详细诊断
python test_communication_v2.py
```

## 🔍 技术细节

### 舵机测试实现
- **时间控制**: 基于系统时钟的精确时间间隔控制
- **状态管理**: 使用静态变量管理测试状态和步骤
- **硬件兼容**: 完全兼容现有控制板协议和舵机ID配置

### 通信模块重构
- **协议层抽象**: 统一的通信接口，支持多种底层实现
- **错误恢复**: 自动重连和状态恢复机制
- **性能优化**: 减少通信延迟和提高成功率

## 📊 统计信息

- **新增代码行数**: 1,868行
- **修改文件数**: 14个
- **新增文件数**: 10个
- **修复bug数**: 2个
- **新增功能数**: 3个

## 🐛 已知问题

1. **时钟精度**: STM32的`System_GetTick()`使用简单计数器，精度有限
2. **串口权限**: Linux系统可能需要串口设备权限配置
3. **CommProtocol兼容性**: 部分MaixPy版本可能不支持CommProtocol

## 🔮 下一步计划

1. **实时时钟**: 改进STM32时钟系统，使用硬件定时器
2. **网络通信**: 添加WiFi/以太网通信支持
3. **图像处理优化**: 改进目标检测算法性能
4. **用户界面**: 开发Web界面进行远程控制

## 📞 技术支持

如遇到问题，请参考：
1. `stm32/SERVO_TEST_GUIDE.md` - 舵机测试指南
2. `maixcam/UART_TROUBLESHOOTING.md` - 通信问题排除
3. 运行相应的诊断工具进行自动检测

## 🙏 致谢

感谢用户反馈的通信问题和功能需求，推动了本版本的重要改进。

---

**完整更新日志**: 请查看Git提交历史  
**下载地址**: Git标签 v2.1  
**兼容性**: 与v2.0完全兼容，建议升级
