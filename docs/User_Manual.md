# 激光追踪系统使用手册

## 目录
1. [系统概述](#系统概述)
2. [硬件准备](#硬件准备)
3. [软件安装](#软件安装)
4. [系统连接](#系统连接)
5. [首次使用](#首次使用)
6. [日常操作](#日常操作)
7. [参数调节](#参数调节)
8. [故障排除](#故障排除)
9. [维护保养](#维护保养)

## 系统概述

激光追踪系统是一个基于机器视觉的自动追踪装置，能够：
- 自动检测红色目标物体
- 控制绿色激光指向目标位置
- 实时跟踪移动目标
- 提供高精度的追踪控制

### 系统组成
- **MaixCamPro**: 图像处理单元，负责目标检测
- **STM32F103C8T6**: 主控制器，负责舵机控制
- **Huaner LX-224舵机**: 水平和垂直运动控制
- **绿色激光器**: 指示激光
- **OLED显示屏**: 状态显示
- **控制按键**: 模式切换

## 硬件准备

### 必需硬件清单
- [ ] MaixCamPro开发板
- [ ] STM32F103C8T6最小系统板
- [ ] Huaner LX-224舵机 x2 (ID=1垂直, ID=2水平)
- [ ] 绿色激光器模块
- [ ] OLED显示屏 (128x64)
- [ ] 按键模块
- [ ] LED指示灯
- [ ] 5V电源适配器
- [ ] 杜邦线若干

### 可选硬件
- [ ] 舵机云台支架
- [ ] 激光器固定支架
- [ ] 外壳保护盒

## 软件安装

### STM32端软件
1. **开发环境**: Keil MDK-ARM 5.0或更高版本
2. **编译工具链**: ARM Compiler 5.06或6.x
3. **下载工具**: ST-Link或J-Link

### MaixCam端软件
1. **MaixPy固件**: 确保安装最新版MaixPy固件
2. **Python环境**: Python 3.x
3. **依赖库**: 
   ```bash
   pip install pyserial
   pip install numpy
   ```

### 开发工具(可选)
- **串口调试**: 串口助手或PuTTY
- **图像调试**: MaixPy IDE
- **版本控制**: Git

## 系统连接

### 1. 电源连接
```
5V电源 --> STM32开发板 VCC
5V电源 --> 舵机电源 (红线)
GND    --> 所有设备共地
```

### 2. 通信连接
```
MaixCam端:
Pin 8 (UART TX) --> STM32 PA10 (USART1 RX)
Pin 10(UART RX) --> STM32 PA9  (USART1 TX)
GND             --> STM32 GND

STM32端:
PA2 (USART2 TX) --> 舵机信号线
PA3 (USART2 RX) --> 舵机信号线
```

### 3. 外设连接
```
OLED显示屏:
VCC --> 3.3V
GND --> GND
SCL --> PB6
SDA --> PB7

按键:
KEY --> PA0
GND --> GND

LED:
LED+ --> PA1
LED- --> GND (通过限流电阻)
```

### 4. 控制板和舵机连接
```
STM32与控制板连接:
STM32 PA2(TX) --> 控制板RX
STM32 PA3(RX) --> 控制板TX
STM32 GND --> 控制板GND

控制板与舵机连接:
控制板舵机总线 --> 串联舵机信号线
控制板5V --> 舵机VCC
控制板GND --> 舵机GND

舵机串联配置:
水平舵机 --> 垂直舵机 (串联连接)
```

## 首次使用

### 步骤1: 硬件检查
1. **电源检查**: 确认5V电源正常，电流足够(建议2A以上)
2. **连线检查**: 按照连接图检查所有连线
3. **舵机检查**: 手动转动舵机，确认无卡死
4. **激光器检查**: 确认激光器能正常发光

### 步骤2: 软件烧录
1. **STM32程序烧录**:
   ```bash
   # 使用Keil MDK编译项目
   # 连接ST-Link下载器
   # 点击Download按钮烧录程序
   ```

2. **MaixCam程序上传**:
   ```bash
   # 连接MaixCam到电脑
   # 使用MaixPy IDE或文件传输工具
   scp -r maixcam/* root@192.168.x.x:/root/laser_tracker/
   ```

### 步骤3: 首次启动
1. **上电顺序**:
   - 先给STM32上电
   - 再给MaixCam上电
   - 最后启动MaixCam程序

2. **启动检查**:
   - STM32的OLED显示"Laser Tracker"
   - LED指示灯亮起
   - 舵机移动到中心位置
   - MaixCam程序正常运行

### 步骤4: 基本标定
1. **舵机中心标定**:
   - 系统启动后自动进入标定模式
   - 舵机移动到中心位置(120度)
   - OLED显示"State: CALIB"

2. **相机标定**:
   - 将红色目标物放在相机视野中心
   - 调整相机焦距和角度
   - 确认能正常检测到红色目标

## 日常操作

### 开机操作
1. **标准开机流程**:
   ```
   1. 检查硬件连接
   2. 给系统上电
   3. 等待初始化完成(约5秒)
   4. 系统进入标定模式
   ```

2. **状态指示**:
   - **OLED显示**: 显示当前系统状态
   - **LED指示**: 常亮=正常，闪烁=追踪，快闪=错误
   - **控制板状态**: OLED显示"CtrlBoard OK"表示控制板通信正常

### 模式切换
使用按键切换系统工作模式：

1. **标定模式 (CALIB)**:
   - 舵机移动到中心位置
   - 用于系统标定和调试
   - 按键切换到追踪模式

2. **追踪模式 (TRACK)**:
   - 自动检测红色目标
   - 激光自动指向目标
   - 按键切换到手动模式

3. **手动模式 (MANUAL)**:
   - 禁用自动追踪
   - 可手动控制舵机
   - 按键切换回标定模式

### 追踪操作
1. **目标准备**:
   - 使用鲜艳的红色物体作为目标
   - 目标大小建议2-10cm
   - 确保目标在相机视野内

2. **开始追踪**:
   - 将系统切换到追踪模式
   - 放置红色目标物
   - 观察激光是否指向目标
   - 移动目标测试追踪效果

3. **追踪监控**:
   - **OLED显示信息**:
     ```
     State: TRACK      # 当前状态
     T:320,240        # 目标位置
     L:315,245        # 激光位置
     O:2.5,-1.2       # PID输出
     ```

### 关机操作
1. **正常关机**:
   - 停止MaixCam程序
   - 切换到标定模式
   - 断开电源

2. **紧急停止**:
   - 直接断开电源
   - 系统具有断电保护

## 参数调节

### 图像检测参数
在MaixCam的`config.py`中调整：

```python
# 红色目标检测阈值 (LAB色彩空间)
RED_TARGET_THRESHOLD = (30, 100, 15, 127, 15, 127)
# 参数说明: (L_min, L_max, A_min, A_max, B_min, B_max)

# 绿色激光检测阈值
GREEN_LASER_THRESHOLD = (30, 100, -64, -8, -32, 32)

# 检测区域大小
MIN_BLOB_AREA = 50      # 最小检测区域
MAX_BLOB_COUNT = 10     # 最大检测数量
```

### PID控制参数
可通过MaixCam动态调整或在STM32代码中修改：

```python
# 水平轴PID参数
PID_KP_H = 2.0    # 比例增益 (响应速度)
PID_KI_H = 0.1    # 积分增益 (消除稳态误差)
PID_KD_H = 0.5    # 微分增益 (减少超调)

# 垂直轴PID参数
PID_KP_V = 2.5    # 比例增益
PID_KI_V = 0.15   # 积分增益
PID_KD_V = 0.6    # 微分增益
```

### 参数调节指南
1. **检测不到目标**:
   - 调整光照条件
   - 修改颜色阈值范围
   - 检查目标颜色是否符合要求

2. **追踪不稳定**:
   - 降低PID比例增益(Kp)
   - 增加微分增益(Kd)
   - 检查机械结构是否稳固

3. **响应太慢**:
   - 增加比例增益(Kp)
   - 适当增加积分增益(Ki)
   - 检查控制频率设置

4. **追踪精度不够**:
   - 增加积分增益(Ki)
   - 调整死区参数
   - 优化相机标定

## 故障排除

### 常见问题及解决方案

#### 1. 系统无法启动
**症状**: OLED无显示，LED不亮
**检查项目**:
- [ ] 电源是否正常(5V/2A)
- [ ] STM32程序是否正确烧录
- [ ] 硬件连接是否正确

**解决方案**:
1. 检查电源电压和电流
2. 重新烧录STM32程序
3. 检查所有连线

#### 2. 通信连接失败
**症状**: MaixCam无法与STM32通信
**检查项目**:
- [ ] 串口连线是否正确
- [ ] 波特率是否一致(115200)
- [ ] 是否有其他程序占用串口

**解决方案**:
```bash
# 检查串口设备
ls /dev/ttyS*

# 测试串口通信
echo "test" > /dev/ttyS1

# 重启通信程序
python main.py
```

#### 3. 舵机不响应
**症状**: 舵机不动或运动异常
**检查项目**:
- [ ] 舵机电源是否正常(5V)
- [ ] 舵机ID是否正确设置
- [ ] 舵机是否损坏或卡死

**解决方案**:
1. 检查舵机电源和连线
2. 使用舵机调试软件测试
3. 重新设置舵机ID

#### 4. 检测不到目标
**症状**: 无法检测红色目标物
**检查项目**:
- [ ] 光照条件是否合适
- [ ] 目标颜色是否鲜艳
- [ ] 相机焦距是否调整好

**解决方案**:
1. 调整环境光照
2. 使用标准红色目标
3. 重新调整颜色阈值

#### 5. 追踪不稳定
**症状**: 激光抖动或无法稳定指向目标
**检查项目**:
- [ ] PID参数是否合理
- [ ] 机械结构是否稳固
- [ ] 控制频率是否足够

**解决方案**:
1. 重新调整PID参数
2. 检查机械连接
3. 增加阻尼或减震

### 错误代码说明
系统会在OLED上显示错误状态：

- **ERROR 01**: 通信超时
- **ERROR 02**: 舵机响应超时
- **ERROR 03**: PID计算错误
- **ERROR 04**: 系统初始化失败

## 维护保养

### 日常维护
1. **清洁保养**:
   - 定期清洁相机镜头
   - 清除灰尘和杂物
   - 检查连线是否松动

2. **功能检查**:
   - 每周检查追踪精度
   - 测试各种工作模式
   - 验证参数设置

3. **数据备份**:
   - 备份调试好的参数
   - 保存系统配置文件
   - 记录使用日志

### 定期维护
1. **月度检查**:
   - 检查舵机磨损情况
   - 测试系统响应时间
   - 更新软件版本

2. **季度保养**:
   - 深度清洁设备
   - 检查电源和连线
   - 重新标定系统

3. **年度维护**:
   - 更换易损件
   - 全面性能测试
   - 系统升级

### 备件建议
- 备用舵机 x1
- 备用激光器 x1
- 常用连线若干
- 保险丝若干

## 技术支持

### 联系方式
- **技术文档**: 参考docs目录下的详细文档
- **问题反馈**: 通过GitHub Issues提交
- **社区支持**: 相关技术论坛

### 常用资源
- [STM32参考手册](https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf)
- [MaixPy文档](https://maixpy.sipeed.com/)
- [Huaner舵机协议](舵机通信协议/通信协议.md)

## 高级功能

### 自动标定功能
系统支持四角标定功能，提高追踪精度：

1. **启动标定模式**:
   ```python
   # 在MaixCam端执行
   tracker.start_calibration()
   ```

2. **标定步骤**:
   - 将红色目标放在图像四个角落
   - 系统自动记录对应的舵机角度
   - 建立坐标映射关系

3. **标定验证**:
   - 测试各个位置的追踪精度
   - 调整标定参数
   - 保存标定结果

### 多目标追踪
系统可以检测多个红色目标：

1. **配置参数**:
   ```python
   MAX_TARGETS = 3  # 最大目标数量
   TARGET_PRIORITY = "largest"  # 优先级: largest/nearest/center
   ```

2. **目标选择策略**:
   - **最大目标**: 追踪面积最大的目标
   - **最近目标**: 追踪距离激光最近的目标
   - **中心目标**: 追踪最靠近图像中心的目标

### 轨迹预测
系统具备简单的轨迹预测功能：

1. **预测算法**:
   - 基于历史位置数据
   - 线性预测运动轨迹
   - 提前调整舵机位置

2. **参数设置**:
   ```python
   PREDICTION_STEPS = 3      # 预测步数
   PREDICTION_WEIGHT = 0.3   # 预测权重
   ```

### 数据记录功能
系统可以记录追踪数据用于分析：

1. **记录内容**:
   - 目标位置坐标
   - 激光位置坐标
   - PID输出值
   - 系统状态信息

2. **数据格式**:
   ```csv
   timestamp,target_x,target_y,laser_x,laser_y,pid_h,pid_v,state
   1234567890,320,240,318,242,1.5,-0.8,TRACK
   ```

## 性能优化

### 图像处理优化
1. **分辨率设置**:
   ```python
   # 平衡处理速度和精度
   CAMERA_WIDTH = 320   # 推荐320x240
   CAMERA_HEIGHT = 240
   ```

2. **ROI设置**:
   ```python
   # 设置感兴趣区域，减少计算量
   ROI_X = 80
   ROI_Y = 60
   ROI_W = 160
   ROI_H = 120
   ```

3. **帧率控制**:
   ```python
   TARGET_FPS = 30      # 目标帧率
   SKIP_FRAMES = 1      # 跳帧处理
   ```

### 控制系统优化
1. **控制频率**:
   ```c
   #define CONTROL_FREQUENCY   50    // 50Hz控制频率
   #define CONTROL_PERIOD_MS   20    // 20ms控制周期
   ```

2. **滤波器设置**:
   ```c
   // 低通滤波器参数
   #define FILTER_ALPHA        0.8f  // 滤波系数
   #define NOISE_THRESHOLD     2.0f  // 噪声阈值
   ```

### 通信优化
1. **数据压缩**:
   - 使用16位坐标代替32位
   - 压缩状态信息
   - 减少不必要的数据传输

2. **协议优化**:
   - 增加数据包优先级
   - 实现重传机制
   - 优化校验算法

## 扩展功能

### 语音控制
可以添加语音控制模块：

1. **硬件需求**:
   - 麦克风模块
   - 语音识别芯片

2. **控制命令**:
   - "开始追踪" / "停止追踪"
   - "切换模式"
   - "重新标定"

### 远程控制
支持网络远程控制：

1. **WiFi连接**:
   ```python
   # MaixCam连接WiFi
   import network
   wlan = network.WLAN(network.STA_IF)
   wlan.connect('SSID', 'PASSWORD')
   ```

2. **Web界面**:
   - 实时图像显示
   - 参数在线调整
   - 状态监控

### 移动端APP
开发手机APP进行控制：

1. **功能特性**:
   - 蓝牙连接控制
   - 参数调节界面
   - 实时状态显示

2. **开发平台**:
   - Android Studio
   - Flutter
   - React Native

## 安全注意事项

### 激光安全
1. **激光等级**: 使用Class 1或Class 2激光器
2. **防护措施**:
   - 避免直射眼睛
   - 使用激光防护眼镜
   - 设置激光功率限制

3. **安全标识**: 在设备上贴上激光警告标识

### 电气安全
1. **电源安全**:
   - 使用合格的电源适配器
   - 避免过载运行
   - 设置过流保护

2. **接地保护**:
   - 确保设备良好接地
   - 使用三线电源线
   - 定期检查绝缘

### 机械安全
1. **运动安全**:
   - 设置运动限位
   - 避免高速运动
   - 定期检查机械磨损

2. **固定安全**:
   - 确保设备稳固安装
   - 避免振动和冲击
   - 使用防护罩

## 故障诊断流程图

```
系统启动
    ↓
电源检查 → 异常 → 检查电源和连线
    ↓ 正常
程序加载 → 异常 → 重新烧录程序
    ↓ 正常
硬件初始化 → 异常 → 检查硬件连接
    ↓ 正常
通信建立 → 异常 → 检查串口设置
    ↓ 正常
舵机测试 → 异常 → 检查舵机和电源
    ↓ 正常
相机测试 → 异常 → 检查相机和光照
    ↓ 正常
系统就绪
```

## 版本更新记录

### v1.0.0 (当前版本)
- 基础追踪功能
- PID控制系统
- 串口通信协议
- OLED状态显示

### 计划更新
- v1.1.0: 添加轨迹预测功能
- v1.2.0: 支持多目标追踪
- v1.3.0: 增加网络控制功能
- v2.0.0: 全面UI重构

---

**注意事项**:
1. 使用激光器时注意安全，避免直射眼睛
2. 确保电源功率足够，避免欠压运行
3. 定期备份重要参数和配置
4. 遵守当地法律法规，合理使用设备
5. 定期检查系统状态，及时维护保养
6. 使用过程中如有异常，立即停止使用并检查
