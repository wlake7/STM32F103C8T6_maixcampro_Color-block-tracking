# STM32调试参数速查表

## 🔥 核心监控参数 (必看)

| 参数名称 | 数据类型 | 正常范围 | 位置 | 说明 |
|---------|---------|---------|------|------|
| **System_GetTick()** | uint32_t | 递增 | Timer.c | 系统时间(ms) |
| **servo_h_pos** | uint16_t | 0-1000 | LaserTracker.c | 水平舵机位置 |
| **servo_v_pos** | uint16_t | 0-1000 | LaserTracker.c | 垂直舵机位置 |
| **target.x** | int16_t | 0-640 | CameraComm.c | 红色目标X坐标 |
| **target.y** | int16_t | 0-480 | CameraComm.c | 红色目标Y坐标 |
| **target.valid** | uint8_t | 0/1 | CameraComm.c | 目标数据有效 |
| **laser.x** | int16_t | 0-640 | CameraComm.c | 绿色激光X坐标 |
| **laser.y** | int16_t | 0-480 | CameraComm.c | 绿色激光Y坐标 |
| **laser.valid** | uint8_t | 0/1 | CameraComm.c | 激光数据有效 |
| **pid_output_h** | float | ±50.0 | LaserTracker.c | 水平PID输出 |
| **pid_output_v** | float | ±50.0 | LaserTracker.c | 垂直PID输出 |
| **packets_received** | uint32_t | 递增 | CameraComm.c | 接收包计数 |
| **packets_error** | uint32_t | 低值 | CameraComm.c | 错误包计数 |

## 🎯 PID控制逻辑说明

**控制目标**: 绿色激光追踪红色目标色块
- **目标位置**: 摄像头识别的红色色块坐标 (target.x, target.y)
- **当前位置**: 摄像头识别的绿色激光坐标 (laser.x, laser.y)
- **PID计算**: PID_Calculate(目标位置, 激光位置)
- **控制输出**: PID输出转换为舵机位置增量

## ⚙️ PID控制参数

| 参数 | 水平轴 | 垂直轴 | 位置 | 调试建议 |
|------|--------|--------|------|----------|
| **Kp** | 2.0f | 2.0f | LaserTracker.c:41,44 | 响应速度 |
| **Ki** | 0.01f | 0.01f | LaserTracker.c:41,44 | 稳态误差 |
| **Kd** | 0.1f | 0.1f | LaserTracker.c:41,44 | 抑制超调 |
| **max_output** | 50.0f | 50.0f | LaserTracker.c:41,44 | 输出限幅 |
| **CONTROL_GAIN** | 0.05f | 0.05f | LaserTracker.h:59 | 控制增益 |
| **DEADZONE_PIXELS** | 3.0f | 3.0f | LaserTracker.h:60 | 死区大小 |

## 📡 通信配置参数

| 接口 | 波特率 | 引脚 | 超时(ms) | 协议头 |
|------|--------|------|----------|--------|
| **USART1** (摄像头) | 115200 | PA9/PA10 | 10000 | 0xAA,0x55 |
| **USART2** (舵机) | 9600 | PA2/PA3 | 1000 | 0x55,0x55 |

## 🎮 舵机参数

| 参数 | 值 | 说明 |
|------|----|----|
| **SERVO_ID_VERTICAL** | 1 | 垂直舵机ID |
| **SERVO_ID_HORIZONTAL** | 2 | 水平舵机ID |
| **SERVO_POSITION_CENTER** | 500 | 中心位置 |
| **SERVO_POSITION_MIN** | 0 | 最小位置 |
| **SERVO_POSITION_MAX** | 1000 | 最大位置 |

## 🖥️ OLED显示格式

### 激光追踪模式 (MODE_LASER_TRACK)
```
行1: SYS:123456        // 系统时间
行2: T:320,240 L:315,235  // 目标和激光位置  
行3: E:+05,-05 I:+2,-1    // 误差和增量
行4: Servo:502,498        // 舵机位置
```

### 通信调试模式 (MODE_COMM_DEBUG)
```
行1: COMM: OK          // 通信状态
行2: RX:0123 ERR:005   // 接收和错误包数
行3: T:320,240 S:500   // 目标位置和H舵机
行4: L:315,235 S:498   // 激光位置和V舵机
```

## 🔧 模式切换

| 模式 | 宏定义值 | 主循环频率 | 用途 |
|------|----------|------------|------|
| **MODE_SERVO_TEST** | 1 | 0.5Hz | 舵机基本测试 |
| **MODE_LASER_TRACK** | 2 | 50Hz | 激光追踪 |
| **MODE_COMM_DEBUG** | 3 | 10Hz | 通信调试 |
| **MODE_SERVO_DEBUG** | 4 | 1Hz | 舵机专项调试 |
| **MODE_CONTROL_TEST** | 5 | 0.5Hz | 控制方向测试 |

**切换方法**: 修改main.c第37行 `#define CURRENT_MODE`

## ⚡ 性能指标

| 指标 | 目标值 | 监控参数 |
|------|--------|----------|
| **控制频率** | 50Hz | 主循环周期20ms |
| **通信延迟** | <20ms | last_receive_time |
| **响应时间** | <100ms | 数据接收到舵机动作 |
| **追踪精度** | ±5像素 | error_x, error_y |

## 🚨 故障诊断

### 系统不工作
1. 检查 **System_GetTick()** 是否递增
2. 检查 **g_system_initialized** 是否为1
3. 检查 **LED心跳** 是否闪烁

### 通信异常
1. 检查 **communication_ok** 是否为true
2. 检查 **packets_received** 是否递增
3. 检查 **packets_error** 比例是否过高

### 舵机不动
1. 检查 **servo_command_count** 是否递增
2. 检查 **servo_h_pos, servo_v_pos** 是否变化
3. 检查舵机位置是否在0-1000范围内

### 追踪不准
1. 检查 **target.valid, laser.valid** 是否为1
2. 检查 **error_x, error_y** 是否合理
3. 检查 **PID输出** 是否在限幅范围内

## 📍 关键代码位置

| 功能 | 文件 | 行号 | 说明 |
|------|------|------|------|
| **PID参数设置** | LaserTracker.c | 41,44 | 水平和垂直PID初始化 |
| **控制增益** | LaserTracker.h | 59-61 | CONTROL_GAIN等参数 |
| **舵机ID定义** | ServoBoard.h | 34-35 | 垂直和水平舵机ID |
| **通信配置** | CameraComm.h | 19-24 | USART1配置 |
| **模式切换** | main.c | 37 | CURRENT_MODE定义 |
| **OLED显示** | main.c | 232-236 | 初始化显示内容 |

## 🎯 调试优先级

### 🔴 高优先级 (必须正常)
- System_GetTick() 递增
- communication_ok = true
- target.valid, laser.valid = 1
- servo_h_pos, servo_v_pos 在0-1000范围

### 🟡 中优先级 (影响性能)
- packets_error 比例 <5%
- error_x, error_y 绝对值 <50像素
- PID输出在限幅范围内

### 🟢 低优先级 (优化项)
- 控制频率稳定在50Hz
- 响应时间 <100ms
- 追踪精度 ±5像素

## 💡 调试技巧

1. **先验证系统时间**: System_GetTick()必须正常递增
2. **再检查通信**: packets_received必须递增
3. **然后验证数据**: target和laser的valid标志
4. **最后调PID**: 根据实际响应调整参数
5. **使用OLED**: 实时监控关键数值变化
6. **观察LED**: 心跳指示系统运行状态
