# 舵机控制从位置改为角度的重大改进

## 🎯 改进概述

### 改进目标
将STM32端的舵机控制从**0-1000位置值**改为**0°-240°角度值**，使PID控制更加直观和精确。

### 改进依据
根据**核心规则第7条**和**控制板协议**：
- 舵机转动范围：0°~240°
- 控制角度范围：0~1000对应0°~240°
- 控制板协议：使用角度位置值进行控制

## 🔧 核心修改内容

### 1. 数据结构修改

#### 修改前 (位置控制)
```c
typedef struct {
    // ...
    uint16_t servo_h_pos;       // 水平舵机位置 (0-1000)
    uint16_t servo_v_pos;       // 垂直舵机位置 (0-1000)
    // ...
} LaserTracker_t;
```

#### 修改后 (角度控制)
```c
typedef struct {
    // ...
    float servo_h_angle;        // 水平舵机角度 (0°-240°)
    float servo_v_angle;        // 垂直舵机角度 (0°-240°)
    // ...
} LaserTracker_t;
```

### 2. 参数宏定义重构

#### 新增角度参数宏定义
```c
/* 舵机角度参数宏定义 - 便于调试 */
#define SERVO_ANGLE_MIN     0.0f        // 舵机最小角度 (0°)
#define SERVO_ANGLE_MAX     240.0f      // 舵机最大角度 (240°)
#define SERVO_ANGLE_CENTER  120.0f      // 舵机中心角度 (120°)
#define SERVO_SAFE_MIN      10.0f       // 舵机安全最小角度 (10°)
#define SERVO_SAFE_MAX      230.0f      // 舵机安全最大角度 (230°)

/* 像素到角度转换参数宏定义 - 便于调试 */
#define PIXEL_TO_ANGLE_GAIN_H   (SERVO_ANGLE_MAX / IMAGE_WIDTH)    // 水平像素到角度转换增益
#define PIXEL_TO_ANGLE_GAIN_V   (SERVO_ANGLE_MAX / IMAGE_HEIGHT)   // 垂直像素到角度转换增益
```

#### PID参数调整
```c
// 修改前 (位置控制)
#define PID_MAX_OUTPUT      50.0f       // PID输出限幅 (位置增量)
#define MAX_SERVO_INCREMENT 20.0f       // 舵机最大单次位置增量

// 修改后 (角度控制)
#define PID_MAX_OUTPUT      10.0f       // PID输出限幅 (角度增量，度)
#define MAX_SERVO_INCREMENT 5.0f        // 舵机最大单次角度增量 (度)
```

### 3. 控制逻辑重构

#### 修改前 (位置控制流程)
```c
// 像素误差 -> PID控制 -> 位置增量 -> 位置限幅 -> 直接发送
float error_x = target_x - laser_x;
float pid_output_h = PID_CalculateWithError(&pid_h, error_x);
float h_increment = pid_output_h * SERVO_RESPONSE_GAIN;
int16_t new_h_pos = servo_h_pos + h_increment;
// 位置限幅...
ServoBoard_MoveHV(new_h_pos, new_v_pos, time);
```

#### 修改后 (角度控制流程)
```c
// 像素误差 -> 角度误差 -> PID控制 -> 角度增量 -> 角度限幅 -> 转换为位置发送
float error_x = target_x - laser_x;
float angle_error_h = error_x * PIXEL_TO_ANGLE_GAIN_H;
float pid_output_h = PID_CalculateWithError(&pid_h, angle_error_h);
float h_angle_increment = pid_output_h * SERVO_RESPONSE_GAIN;
float new_h_angle = servo_h_angle + h_angle_increment;
// 角度限幅...
uint16_t servo_h_pos = Angle_ToServoPos(new_h_angle);
ServoBoard_MoveHV(servo_h_pos, servo_v_pos, time);
```

### 4. 新增角度转换函数

```c
/**
 * @brief 角度转换为舵机控制板位置值
 * @param angle 舵机角度 (0°-240°)
 * @return 控制板位置值 (0-1000)
 */
static uint16_t Angle_ToServoPos(float angle)
{
    // 角度限幅
    if (angle < SERVO_ANGLE_MIN) angle = SERVO_ANGLE_MIN;
    if (angle > SERVO_ANGLE_MAX) angle = SERVO_ANGLE_MAX;
    
    // 角度转换为0-1000位置值: 0° -> 0, 240° -> 1000
    uint16_t servo_pos = (uint16_t)((angle / SERVO_ANGLE_MAX) * 1000.0f);
    
    // 再次限幅确保安全
    if (servo_pos > 1000) servo_pos = 1000;
    
    return servo_pos;
}
```

### 5. OLED显示优化

#### 修改前 (显示位置)
```
行3: E:+05,-05 I:+2,-1    // 像素误差和位置增量
行4: Servo:502,498        // 舵机位置 (0-1000)
```

#### 修改后 (显示角度)
```
行3: AE:+12,-08 P:+2,-1   // 角度误差和PID输出
行4: Angle:120,115        // 舵机角度 (0°-240°)
```

## 🎯 改进优势

### 1. 控制精度提升
- **直观性**: 角度控制比位置值更直观，便于理解和调试
- **精确性**: 直接的角度映射关系，避免多次转换误差
- **一致性**: 与舵机物理特性和控制板协议保持一致

### 2. PID参数合理化
- **输出限幅**: 10°角度增量比50位置增量更合理
- **增量限制**: 5°角度增量对应实际物理运动更直观
- **参数调试**: 角度参数更容易理解和调整

### 3. 代码可维护性
- **参数宏定义**: 所有角度相关参数都有明确的宏定义
- **函数封装**: 角度转换逻辑封装在专门函数中
- **兼容性**: 保留位置获取函数，确保向后兼容

### 4. 调试友好性
- **OLED显示**: 显示实际的角度值，更直观
- **参数范围**: 角度范围0°-240°比0-1000更容易理解
- **误差分析**: 角度误差比位置误差更容易分析

## 📊 转换关系

### 角度与位置的转换公式
```c
// 角度转位置: position = (angle / 240.0) * 1000.0
// 位置转角度: angle = (position / 1000.0) * 240.0

// 示例：
// 0° -> 0位置
// 120° (中心) -> 500位置  
// 240° -> 1000位置
```

### 像素到角度的转换
```c
// 水平方向: angle_error = pixel_error * (240.0 / 640.0) = pixel_error * 0.375
// 垂直方向: angle_error = pixel_error * (240.0 / 480.0) = pixel_error * 0.5

// 示例：
// 水平100像素误差 -> 37.5°角度误差
// 垂直100像素误差 -> 50°角度误差
```

## 🔧 调试参数建议

### PID参数调整建议
```c
// 角度控制的PID参数建议范围
#define PID_KP_H            2.0f        // 比例增益 (1.0-5.0)
#define PID_KI_H            0.0f        // 积分增益 (0.0-0.1) - 当前关闭
#define PID_KD_H            0.1f        // 微分增益 (0.01-1.0)
#define PID_MAX_OUTPUT      10.0f       // 输出限幅 (5.0-20.0度)
#define MAX_SERVO_INCREMENT 5.0f        // 增量限制 (2.0-10.0度)
```

### 安全参数建议
```c
#define SERVO_SAFE_MIN      10.0f       // 安全最小角度 (避免机械限位)
#define SERVO_SAFE_MAX      230.0f      // 安全最大角度 (避免机械限位)
```

## 🎯 验证要点

### 1. 角度范围验证
- 舵机角度应在0°-240°范围内
- 安全角度应在10°-230°范围内
- 转换后的位置值应在0-1000范围内

### 2. 控制精度验证
- 小角度变化应能正确响应
- PID输出应在合理范围内 (±10°)
- 舵机运动应平滑无突跳

### 3. 显示一致性验证
- OLED显示的角度值应与实际舵机角度一致
- 角度误差应反映实际的控制需求
- PID输出应对应实际的角度调整

## 💡 后续优化方向

1. **自适应增益**: 根据误差大小自动调整像素到角度的转换增益
2. **非线性映射**: 考虑舵机在不同角度的响应特性
3. **角度反馈**: 如果舵机支持角度回读，可实现闭环角度控制
4. **动态限制**: 根据运动状态动态调整角度增量限制
5. **预测控制**: 基于目标运动趋势预测所需角度
