# 激光追踪系统技术报告

**项目名称**: STM32激光追踪系统
**开发日期**: 2025-07-09
**版本**: v3.0 (激光追踪版)
**开发者**: AI Assistant

## 📋 项目概述

### 🎯 当前阶段目标
**第一阶段**: 验证STM32是否能驱动舵机运动 ✅ **已完成**
**第二阶段**: 实现激光追踪系统 ✅ **当前阶段**

### 🏗️ 当前系统架构
```
MaixCamPro → [UART1通信] → STM32F103C8T6 → [UART2通信] → 舵机控制板 → 双轴舵机 → 激光笔
   ↓                           ↑                                          ↓
[图像处理]                 [PID控制]                                [激光追踪]
[目标检测]                 [Timer1时间]                             [位置反馈]
[激光检测]                 [LED状态指示]                            [闭环控制]
```

### 🔧 设计原则
1. **Timer1时间基准**: 使用定时器1作为系统时间标准，SysTick专用延时
2. **双重时间系统**: Timer1负责系统时间计数，SysTick负责精确延时
3. **宏开关控制**: 使用条件编译切换不同功能模式
4. **模块化中断处理**: 遵循项目要求，中断函数在对应模块中实现
5. **实时PID控制**: 双轴独立PID控制器，支持参数动态调整

## 🔧 硬件配置

### 主控制器
- **MCU**: STM32F103C8T6最小系统板
- **时钟**: 72MHz系统时钟
- **开发环境**: Keil5 + 标准库

### 通信接口
- **USART1**: 与MaixCam摄像头通信 (PA9-TX, PA10-RX, 115200bps)
- **USART2**: 与舵机控制板通信 (PA2-TX, PA3-RX, 9600bps)
- **状态指示**: PC13 LED (板载LED)
- **系统时间**: Timer1 (1ms中断)

### 执行机构
- **舵机**: 幻尔舵机 × 2
  - 垂直舵机: ID=1
  - 水平舵机: ID=2
  - 控制范围: 0-1000 (对应0°-240°)
  - 通信波特率: 9600bps (与控制板通信)
  - 通信: 通过控制板转发

## 💻 软件架构

### 🗂️ 当前实现 (激光追踪版)

#### 1. **主程序** (`main.c`)
**功能**: 激光追踪控制系统
- **宏开关控制**: 使用条件编译切换功能模式
  - `MODE_SERVO_TEST`: 舵机测试模式 ✅ 已实现
  - `MODE_LASER_TRACK`: 激光追踪模式 ✅ 当前实现
  - `MODE_DEBUG`: 调试模式 (预留)
- **激光追踪流程**:
  - 接收摄像头位置数据 → PID计算 → 舵机控制 → 位置反馈
  - 实时处理，20Hz控制频率
- **状态指示**: PC13 LED心跳指示 (1Hz闪烁)

#### 2. **时间管理模块** (`Timer.c/h` + `Delay.c/h`)
**功能**: 双重时间系统
- **Timer1配置**: 1ms系统时间中断 (新增)
- **Timer_GetSystemTick()**: 获取系统毫秒计数 (新增)
- **SysTick配置**: 专用于精确延时
- **System_GetTick()**: 调用Timer模块获取时间
- **延时函数**: 微秒、毫秒、秒级延时 (保持不变)
- **中断处理**: TIM1_UP_IRQHandler在Timer.c中实现

#### 3. **摄像头通信模块** (新增)
**功能**: 与MaixCam摄像头实时通信
- **协议**: 0xAA 0x55 + Length + Cmd + Data
- **波特率**: 115200bps (USART1)
- **接收命令**:
  - CMD_TARGET_POSITION (0x01): 红色目标位置
  - CMD_LASER_POSITION (0x02): 绿色激光位置
  - CMD_PID_PARAMS (0x03): PID参数更新
- **中断接收**: USART1_IRQHandler处理数据包

#### 4. **PID控制模块** (新增)
**功能**: 双轴独立PID控制算法
- **控制器**: 水平PID + 垂直PID
- **参数**: Kp, Ki, Kd可动态调整
- **限幅**: 输出限幅 + 积分限幅
- **实时计算**: 误差 → PID输出 → 舵机位置

#### 5. **舵机通信协议**
**功能**: 直接与舵机控制板通信
- **协议**: 0x55 0x55 + Length + Cmd + Data
- **波特率**: 9600bps (USART2)
- **控制命令**: CMD_SERVO_MOVE (命令3)
- **数据格式**: 舵机个数 + 时间 + [ID + 位置] × N

### ✅ 新增模块
- **Timer模块**: Timer1系统时间管理 (新增)
- **摄像头通信**: USART1实时数据接收 (新增)
- **PID控制器**: 双轴独立PID算法 (新增)
- **激光追踪**: 完整闭环控制系统 (新增)

### 🔄 中断处理架构

**设计原则**: 遵循第8条要求，不在stm32f10x_it.c中编写中断函数

**当前实现**:
1. **Timer1中断**: 在Timer.c中实现TIM1_UP_IRQHandler (系统时间)
2. **SysTick中断**: 在Delay.c中实现SysTick_Handler (专用延时)
3. **USART1中断**: 在main.c中实现USART1_IRQHandler (摄像头通信)
4. **USART2发送**: 仅发送模式，不使用中断接收

```c
// Timer.c - 系统时间管理
void TIM1_UP_IRQHandler(void) {
    g_system_tick_ms++;  // 系统时间计数
}

// Delay.c - 专用延时
void SysTick_Handler(void) {
    // 专用于延时功能
}

// main.c - 摄像头通信
void USART1_IRQHandler(void) {
    // 处理摄像头数据包接收
}
```

**架构优势**: 双重时间系统提供更高精度，模块化中断处理便于维护。

## 📡 通信协议设计

### 📷 摄像头通信协议 (USART1) - 新增实现

**帧格式**:
```
[0xAA][0x55][Length][Cmd][Data...]
```

**目标位置命令** (CMD=0x01):
```
target_x_low(1B) + target_x_high(1B) + target_y_low(1B) + target_y_high(1B)
```

**激光位置命令** (CMD=0x02):
```
laser_x_low(1B) + laser_x_high(1B) + laser_y_low(1B) + laser_y_high(1B)
```

**PID参数命令** (CMD=0x03):
```
kp_h_low(1B) + kp_h_high(1B) + ki_h_low(1B) + ki_h_high(1B) + kd_h_low(1B) + kd_h_high(1B) +
kp_v_low(1B) + kp_v_high(1B) + ki_v_low(1B) + ki_v_high(1B) + kd_v_low(1B) + kd_v_high(1B)
```

**数据流向**: MaixCam → STM32

### 🎛️ 舵机控制协议 (USART2) - 已实现

**帧格式**:
```
[0x55][0x55][Length][Cmd][Data...]
```

**舵机移动命令** (CMD=0x03):
```
servo_count(1B) + time_low(1B) + time_high(1B) + [servo_id(1B) + pos_low(1B) + pos_high(1B)] * N
```

**实际例子**:
- 控制1号舵机到500位置，用时2000ms:
  ```
  0x55 0x55 0x08 0x03 0x01 0xD0 0x07 0x01 0xF4 0x01
  ```
- 控制双舵机到中心位置(500,500)，用时2000ms:
  ```
  0x55 0x55 0x0B 0x03 0x02 0xD0 0x07 0x02 0xF4 0x01 0x01 0xF4 0x01
  ```

**数据流向**: STM32 → 舵机控制板

**数据流向**: STM32 → 舵机控制板

## 🎯 控制算法

### 🎯 激光追踪算法 (当前实现)

**控制流程**:
1. **数据接收**: 从摄像头接收目标位置和激光位置
2. **误差计算**: error = target_pos - laser_pos
3. **PID计算**: 水平和垂直方向独立PID控制
4. **位置更新**: servo_pos += PID_output
5. **舵机控制**: 发送新位置到舵机控制板
6. **循环执行**: 20Hz控制频率

**PID参数**:
- **水平轴**: Kp=2.0, Ki=0.1, Kd=0.5, 输出限幅=±200
- **垂直轴**: Kp=2.0, Ki=0.1, Kd=0.5, 输出限幅=±200
- **积分限幅**: 输出限幅的50%，防止积分饱和

**安全机制**:
- **超时保护**: 1秒无数据自动回中心位置
- **位置限幅**: 舵机位置限制在0-1000范围
- **积分限幅**: 防止PID积分项过大

### 🔧 舵机测试算法 (已实现)

**测试序列**:
1. **初始化**: 舵机回到中心位置 (500, 500)
2. **水平测试**: 左(200) → 右(800) → 中心(500)
3. **垂直测试**: 上(200) → 下(800) → 中心(500)
4. **圆形运动**: 左上 → 右上 → 右下 → 左下 → 中心
5. **循环重复**: 每个动作间隔3秒

**位置映射**:
- **舵机范围**: 0-1000 (对应0°-240°)
- **测试位置**:
  - 最小: 200 (约48°)
  - 中心: 500 (约120°)
  - 最大: 800 (约192°)

### 🔧 优化方向 (后续版本)
- **自适应PID**: 根据误差大小自动调整PID参数
- **预测控制**: 基于目标运动轨迹的预测算法
- **滤波算法**: 卡尔曼滤波、移动平均滤波
- **多目标追踪**: 支持多个目标同时追踪

## 🐍 Python端配置

### 📁 文件结构
- `main.py`: 主程序入口
- `laser_tracker.py`: 激光追踪算法
- `stm32_comm.py`: STM32通信模块 (新增)
- `communication.py`: 原有通信模块
- `config.py`: 配置管理

### 🔗 通信接口
**新增STM32Communication类**:
- 支持UART通信
- 自动重连机制
- 数据包校验
- 统计信息收集

## 📊 系统性能

### 🎯 设计指标
- **追踪精度**: ±5像素
- **响应时间**: <100ms
- **控制频率**: 50Hz
- **通信延迟**: <20ms

### 📈 监控指标
- **帧率**: 实时FPS统计
- **检测率**: 目标/激光检测成功率
- **通信成功率**: 数据包传输成功率
- **PID性能**: 误差统计、收敛时间

## 📊 STM32端调试参数清单

### 🎛️ 系统核心参数

#### 时钟与定时器配置
- **系统时钟**: 72MHz (SystemCoreClock)
- **Timer1配置**:
  - 预分频: 72-1 (得到1MHz)
  - 自动重装载: 1000-1 (1ms中断)
  - 中断优先级: 抢占优先级1, 子优先级0
- **SysTick配置**: 1ms中断 (专用延时)

#### 主循环频率控制
- **激光追踪模式**: 50Hz (20ms周期)
- **通信调试模式**: 10Hz (100ms周期)
- **舵机测试模式**: 0.5Hz (2000ms周期)
- **舵机专项调试**: 1Hz (1000ms周期)

### 🎯 PID控制参数

#### 水平轴PID参数
```c
// LaserTracker.c 第41行
PID_Init(&g_laser_tracker.pid_h, 2.0f, 0.01f, 0.1f, 50.0f);
```
- **Kp_h**: 2.0f (比例增益)
- **Ki_h**: 0.01f (积分增益)
- **Kd_h**: 0.1f (微分增益)
- **max_output_h**: 50.0f (输出限幅)

#### 垂直轴PID参数
```c
// LaserTracker.c 第44行
PID_Init(&g_laser_tracker.pid_v, 2.0f, 0.01f, 0.1f, 50.0f);
```
- **Kp_v**: 2.0f (比例增益)
- **Ki_v**: 0.01f (积分增益)
- **Kd_v**: 0.1f (微分增益)
- **max_output_v**: 50.0f (输出限幅)

#### 控制算法参数
```c
// LaserTracker.h 第59-61行
#define CONTROL_GAIN        0.05f       // 比例控制增益
#define DEADZONE_PIXELS     3.0f        // 死区像素数
#define MAX_INCREMENT       10.0f       // 最大单次增量
```

### 🎮 舵机控制参数

#### 舵机硬件规格
- **转动范围**: 0°~240° (对应控制值0~1000)
- **舵机精度**: 0.3°
- **转动速度**: 0.20sec/60°@7.4V
- **堵转扭矩**: 20kg.cm@7.4V
- **工作电流**: 空载100mA, 堵转2.4~3A

#### 舵机ID配置
```c
// ServoBoard.h 第34-35行
#define SERVO_ID_VERTICAL           1               // 垂直舵机ID
#define SERVO_ID_HORIZONTAL         2               // 水平舵机ID
```

#### 舵机位置范围
```c
// ServoBoard.h 第38-40行
#define SERVO_POSITION_MIN          0               // 最小位置
#define SERVO_POSITION_MAX          1000            // 最大位置
#define SERVO_POSITION_CENTER       500             // 中心位置
```

#### 舵机运动时间参数
- **激光追踪模式**: 50ms (快速响应)
- **测试模式**: 200ms (平滑运动)
- **回中心**: 1000ms (缓慢稳定)

### 📡 通信协议参数

#### 摄像头通信 (USART1)
```c
// CameraComm.h 第19-24行
#define CAMERA_UART                 USART1
#define CAMERA_UART_BAUDRATE        115200
#define CAMERA_UART_TX_PIN          GPIO_Pin_9      // PA9
#define CAMERA_UART_RX_PIN          GPIO_Pin_10     // PA10
#define CAMERA_COMM_TIMEOUT_MS      10000           // 通信超时
```

#### 舵机控制板通信 (USART2)
```c
// ServoBoard.h 第19-24行
#define SERVO_UART                  USART2
#define SERVO_UART_BAUDRATE         9600
#define SERVO_UART_TX_PIN           GPIO_Pin_2      // PA2
#define SERVO_UART_RX_PIN           GPIO_Pin_3      // PA3
#define SERVO_COMM_TIMEOUT_MS       1000            // 通信超时
```

#### 协议帧格式
- **摄像头协议**: 帧头[0xAA, 0x55] + 长度 + 命令 + 数据 + 校验和
- **舵机协议**: 帧头[0x55, 0x55] + 长度 + 命令 + 数据

### 🖥️ OLED调试显示参数

#### 显示布局 (激光追踪模式)
```c
// main.c 第232-236行
OLED_ShowString(1, 1, "SYS:");           // 第1行: 系统时间
OLED_ShowString(3, 1, "H:");             // 第3行: 水平舵机位置
OLED_ShowString(3, 7, "V:");             // 第3行: 垂直舵机位置
OLED_ShowString(4, 1, "T:--- L:---");    // 第4行: 目标和激光位置
```

#### 实时更新参数
- **系统时间**: System_GetTick() (毫秒计数)
- **舵机位置**: servo_h_pos, servo_v_pos (0-1000)
- **目标坐标**: target.x, target.y (像素坐标)
- **激光坐标**: laser.x, laser.y (像素坐标)
- **通信统计**: packets_received, packets_error
- **PID输出**: pid_output_h, pid_output_v

### 🔧 图像处理参数

#### 图像坐标系
```c
// LaserTracker.h 第48-51行
#define IMAGE_WIDTH         640
#define IMAGE_HEIGHT        480
#define IMAGE_CENTER_X      (IMAGE_WIDTH / 2)      // 320
#define IMAGE_CENTER_Y      (IMAGE_HEIGHT / 2)     // 240
```

#### 坐标转换参数
- **像素到舵机位置**: position = (pixel * 1000) / image_size
- **PID输出到位置偏移**: offset = output * 0.5f

### ⚡ 性能监控参数

#### 通信统计
- **发送包计数**: packets_sent
- **接收包计数**: packets_received
- **错误包计数**: packets_error
- **超时次数**: timeouts
- **最后接收时间**: last_receive_time

#### 系统状态标志
- **系统初始化**: g_system_initialized
- **追踪激活**: tracking_active
- **通信状态**: communication_ok
- **数据有效性**: target.valid, laser.valid

### 🎚️ 可调试的关键参数

#### 需要实时监控的数值
1. **系统时间**: System_GetTick() - 验证定时器工作
2. **舵机位置**: servo_h_pos, servo_v_pos - 验证控制输出
3. **目标坐标**: target.x, target.y - 验证图像识别
4. **激光坐标**: laser.x, laser.y - 验证激光检测
5. **位置误差**: error_x, error_y - 验证控制算法
6. **PID输出**: pid_output_h, pid_output_v - 验证控制响应
7. **通信计数**: RX包数, 错误包数 - 验证通信质量
8. **响应时间**: 从接收数据到舵机动作的延迟

#### 需要调优的参数
1. **PID增益**: Kp, Ki, Kd - 根据实际响应调整
2. **控制增益**: CONTROL_GAIN - 调整响应灵敏度
3. **死区大小**: DEADZONE_PIXELS - 减少抖动
4. **最大增量**: MAX_INCREMENT - 限制突变
5. **运动时间**: 舵机移动时间 - 平衡速度与稳定性
6. **更新频率**: 主循环和显示更新频率 - 优化性能

## 🔧 调试与测试

### 🖥️ 调试输出
- **串口调试**: USART1输出详细日志
- **LED指示**: PC13状态指示灯
- **统计报告**: 定期输出系统状态

### 🧪 测试方法
1. **硬件连接测试**: 验证串口通信
2. **模块独立测试**: 各模块功能验证
3. **集成测试**: 完整系统联调
4. **性能测试**: 追踪精度和响应时间

## ⚠️ 已知问题与解决方案

### 🔧 技术挑战
1. **时钟配置**: 确保72MHz系统时钟正确配置
2. **中断冲突**: 通过模块化中断处理避免
3. **通信稳定性**: 实现自动重连和错误恢复
4. **PID调参**: 提供实时参数调整接口

### 🛠️ 解决方案
1. **SysTick配置**: 在main.c中正确配置1ms中断
2. **模块化设计**: 各模块独立实现中断处理
3. **健康检查**: 实时监控通信状态
4. **参数优化**: 支持运行时PID参数调整

## 🚀 后续优化方向

### 📈 性能提升
1. **算法优化**: 卡尔曼滤波、预测控制
2. **硬件升级**: 更高精度的舵机、更快的处理器
3. **通信优化**: 更高波特率、数据压缩

### 🔧 功能扩展
1. **多目标追踪**: 支持多个目标同时追踪
2. **自适应控制**: 根据环境自动调整参数
3. **远程监控**: 网络接口、远程调试

## 📝 总结

### ✅ 当前完成 (激光追踪版)

**第一阶段 - 舵机控制验证**:
✅ **硬件通信**: STM32与舵机控制板9600bps通信正常
✅ **协议实现**: 正确实现舵机控制板通信协议
✅ **运动控制**: 双轴舵机独立和联合控制
✅ **测试序列**: 完整的舵机运动测试流程

**第二阶段 - 激光追踪系统**:
✅ **Timer1时间系统**: 使用定时器1作为系统时间标准
✅ **双重时间架构**: Timer1系统时间 + SysTick延时
✅ **摄像头通信**: USART1与MaixCam实时通信
✅ **PID控制算法**: 双轴独立PID控制器
✅ **数据包处理**: 完整的通信协议解析
✅ **闭环控制**: 目标检测→PID计算→舵机控制
✅ **安全机制**: 超时保护、位置限幅、积分限幅
✅ **宏开关控制**: 条件编译支持多模式切换
✅ **规范开发**: 遵循项目要求，中断函数模块化实现

**第三阶段 - PID控制优化** (2025-07-11):
✅ **完整PID控制**: 替代简单比例控制，使用完整PID算法
✅ **参数宏定义**: 所有调试参数使用宏定义，便于调试优化
✅ **安全保护机制**: 增加误差限制、安全位置范围等保护
✅ **调试开关**: 支持OLED调试、PID调试、安全检查等开关
✅ **优化显示**: OLED显示PID输出、舵机增量等关键调试信息

### 🔧 待优化 (后续版本)

**性能优化**:
🔲 **参数自适应**: 根据追踪效果自动调整PID参数
🔲 **预测控制**: 基于目标运动轨迹的预测算法
🔲 **滤波优化**: 卡尔曼滤波减少噪声影响
🔲 **多目标支持**: 支持多个目标同时追踪

### 🎯 验证结果

**第一阶段目标**: ✅ **已完成**
- 验证STM32能否驱动舵机运动

**第二阶段目标**: ✅ **已完成**
- 实现完整的激光追踪闭环控制系统
- 建立稳定的摄像头-STM32-舵机通信链路
- 实现实时PID控制算法

**系统状态**: 🟢 **激光追踪系统就绪，可进行实际测试**

## 📱 OLED显示优化 (2025-07-11)

### 🎯 优化目标
根据核心规则第19条："oled显示的调试信息一定要有用，显示核心具体数值，不用显示什么'welcome'，'当前模式'"

### 🔧 修改内容

#### 1. **系统初始化显示**
**修改前**:
```
SERVO_TEST / LASER_TRACK / COMM_DEBUG / SERVO_DEBUG / CTRL_TEST
```

**修改后**:
```
SYS:123456    // 系统时间(ms)
INIT OK       // 初始化状态
H:500 V:500   // 初始舵机位置
T:--- L:---   // 目标和激光位置占位
```

#### 2. **通信调试模式**
**修改前**:
```
COMM DEBUG MODE
Waiting data...
RX: 0
Servo: 500,500
```

**修改后**:
```
RX:0 ERR:0    // 接收包数和错误包数
T:--- L:---   // 目标和激光位置
E:--- I:---   // 误差和增量
S:500,500     // 舵机位置
```

#### 3. **舵机调试模式**
**修改前**:
```
SERVO DEBUG MODE
Testing servo...
Step: 0
Count: 0
```

**修改后**:
```
H:500 V:500   // 当前舵机位置
Step:0 Cnt:0  // 测试步骤和计数
Pos:CENTER    // 当前位置描述
Time:123456   // 系统时间
```

#### 4. **控制测试模式**
**修改前**:
```
CONTROL TEST
Testing direction
Step: 0
Watch laser move
```

**修改后**:
```
T:320,240     // 目标位置
L:320,240     // 激光位置
Step:0 Dir:-- // 测试步骤和方向
S:500,500     // 舵机位置
```

#### 5. **激光追踪模式**
**已优化** (LaserTracker.c):
```
T:320,240 L:320,240  // 目标和激光位置
E:+10,-05 I:+2,-1    // 误差和增量
Servo:520,495        // 舵机位置
TIMEOUT:5s           // 超时显示(具体秒数)
```

### ✅ 优化效果
1. **信息密度提升**: 每行显示更多有用数值
2. **实时性增强**: 显示动态变化的核心参数
3. **调试效率**: 一目了然的关键数值
4. **符合规范**: 严格遵循核心规则第19条要求

### 🎯 显示原则
- ✅ **显示核心数值**: 位置、误差、时间、计数等
- ✅ **实时更新**: 动态变化的关键参数
- ✅ **信息密度**: 最大化有用信息显示
- ❌ **禁止显示**: 欢迎信息、模式名称、无用提示
