# 激光追踪系统诊断指南

## 🔍 问题现状
- **现象**: 追踪模式舵机不能追踪
- **已调整**: PID参数从Kp=2.0调整到Kp=8.0
- **需要检查**: 摄像头↔STM32通信、STM32↔舵机控制板通信、PID控制逻辑

## 🛠️ 诊断步骤

### 第一步：MaixCam端通信测试

#### 1.1 配置并运行通信诊断模式
```bash
cd maixcam
# 编辑 run_config.py，设置 RUN_MODE = 2
python main.py
```

**配置方法**:
- 打开 `maixcam/run_config.py`
- 修改 `RUN_MODE = 2` (通信诊断模式)
- 保存文件后运行 `python main.py`

**预期结果**:
- ✓ UART初始化成功: /dev/ttyS2@115200
- ✓ 引脚映射配置成功
- ✓ 目标位置数据包发送完成
- ✓ 激光位置数据包发送完成

#### 1.2 检查要点
- **串口配置**: 使用/dev/ttyS2（串口2）
- **引脚映射**: A29(RX), A28(TX)自动配置
- **数据包格式**: [0xAA, 0x55, Length, Cmd, Data...]
- **统一入口**: 所有功能从main.py进入

### 第二步：STM32端通信诊断

#### 2.1 编译并烧录通信调试模式
```c
// main.c中已设置
#define CURRENT_MODE        MODE_COMM_DEBUG
```

#### 2.2 观察LED指示
- **初始化**: LED快闪4次表示初始化完成
- **数据接收**: 每收到数据LED短闪一次
- **统计信息**: 每5秒通过LED闪烁显示统计
  - 快闪次数 = 总数据包数/10
  - 慢闪次数 = 目标数据包数/5

#### 2.3 舵机响应测试
- 通信调试模式会根据接收到的目标位置直接控制舵机
- 舵机应该跟随MaixCam发送的目标位置移动

### 第三步：PID控制逻辑检查

#### 3.1 已修复的问题
```c
// 修复前（错误）:
float h_output = PID_Calculate(&pid_h, 0.0f, h_error);

// 修复后（正确）:
float h_output = PID_Calculate(&pid_h, target_pos.x, laser_pos.x);
```

#### 3.2 PID参数调整
- **当前参数**: Kp=8.0, Ki=0.1, Kd=0.5
- **输出限幅**: ±200
- **积分限幅**: ±100

### 第四步：端到端测试

#### 4.1 切换到激光追踪模式
```c
#define CURRENT_MODE        MODE_LASER_TRACK
```

#### 4.2 运行完整系统
```bash
# MaixCam端
cd maixcam
# 编辑 run_config.py，设置 RUN_MODE = 1
python main.py
```

## 🔧 常见问题与解决方案

### 问题1：MaixCam无法发送数据
**症状**: 通信诊断模式报告UART初始化失败
**解决**:
- 检查硬件连接
- 确认使用/dev/ttyS2和正确的引脚映射
- 检查MaixCam是否正常启动

### 问题2：STM32收不到数据
**症状**: LED不闪烁，舵机不动
**解决**:
- 检查串口连接：MaixCam A28(TX)→STM32 PA10(RX), MaixCam A29(RX)→STM32 PA9(TX)
- 检查波特率：115200
- 检查共地连接

### 问题3：收到数据但舵机不动
**症状**: LED闪烁但舵机无响应
**解决**:
- 检查STM32↔舵机控制板连接（USART2）
- 检查舵机控制板电源
- 检查ServoBoard模块初始化

### 问题4：舵机动作异常
**症状**: 舵机移动但不准确
**解决**:
- 调整PID参数
- 检查坐标转换逻辑
- 验证舵机位置范围（0-1000）

## 📊 诊断数据记录表

### MaixCam端测试结果
- [ ] UART初始化成功
- [ ] 数据包发送成功
- [ ] 连续数据发送正常
- [ ] 无错误信息

### STM32端测试结果
- [ ] LED初始化指示正常
- [ ] 数据接收LED闪烁
- [ ] 舵机响应测试正常
- [ ] 统计信息LED显示

### 通信质量评估
- 数据包发送频率: _____ Hz
- 数据包丢失率: _____ %
- 舵机响应延迟: _____ ms

## 🎯 预期结果

**正常工作状态**:
1. MaixCam成功发送位置数据
2. STM32接收数据并控制舵机移动
3. 舵机位置跟随目标位置变化
4. LED指示正常的数据流

**完成标志**:
- 通信调试模式下舵机能跟随目标位置移动
- 激光追踪模式下PID控制正常工作
- 系统响应及时，无明显延迟

## 📝 下一步优化

1. **PID参数微调**: 根据实际效果调整Kp、Ki、Kd
2. **滤波算法**: 添加位置数据滤波减少噪声
3. **预测控制**: 实现目标运动预测
4. **性能监控**: 添加实时性能指标显示
